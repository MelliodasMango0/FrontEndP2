<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gyroscopic Fireball</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.3/lib/p5.min.js"></script>
</head>
<body>
    <script>
        let button;
        let permissionGranted = false;
        let cx, cy; // Position of the circle
        let velocityX = 0, velocityY = 0; // Simulated velocity
        let lastCx = 0, lastCy = 0;

        let particles = []

        function requestAccess() {
            DeviceOrientationEvent.requestPermission()
            .then(response => {
                if (response == 'granted') {
                    permissionGranted = true;
                    button.remove();
                }
            })
            .catch(console.error);
        }

        function touchMoved() {
            return false;
        }
        function setup() {
            createCanvas(windowWidth, windowHeight);
            background(0);
            
            cx = width / 2;
            cy = height / 2;
            lastCx = cx;
            lastCy = cy;

            if (typeof(DeviceOrientationEvent) !== 'undefined' && typeof(DeviceOrientationEvent.requestPermission) == 'function') {
                DeviceOrientationEvent.requestPermission()
                .catch(() => {
                    button = createButton("Click to allow access to sensors");
                    button.style("font-size", "24px");
                    button.center();
                    button.mousePressed(requestAccess);
                    throw new Error("Permission required");
                })
                .then(() => {
                    permissionGranted = true;
                })
            } else {
                permissionGranted = true;
            }
        }

        class Particle {
            constructor(x, y, velocityX, velocityY, speed) {
                this.x = x;
                this.y = y;
                
                // Make particles shoot in the opposite direction of movement
                let randomAngle = random(-0.5, 0.5); // Add some randomness
                this.vx = -velocityX * random(0.3, 0.8) + random(-2, 2);
                this.vy = -velocityY * random(0.3, 0.8) + random(-2, 2);
                
                this.size = random(3, 10);
                this.lifespan = random(150, 255);
                
                // brighter color the faster speed of the ball
                let brightness = constrain(map(speed, 0, 50, 50, 255), 50, 255);
                let redValue = constrain(map(speed, 0, 50, 200, 255), 200, 255);
                let yellowValue = constrain(map(speed, 0, 50, 100, 200), 100, 200);
                
                this.color = color(redValue, yellowValue, random(0, 50), this.lifespan);
            }
            
            update() {
                // Move the particle
                this.x += this.vx;
                this.y += this.vy;
                
                // Slow down
                this.vx *= 0.55;
                this.vy *= 0.55;
                
                this.lifespan -= random(3, 7);
                this.size *= 0.97;
            }
            
            display() {
                noStroke(); // strip the outline 
                fill(this.color);
                this.color.setAlpha(this.lifespan);
                ellipse(this.x, this.y, this.size);
            }
            
            isDead() {
                return this.lifespan <= 0;
            }
        }

        function draw() {
            background(0, 25); // Add slight transparency to create fade effect
            
            // Handle device orientation if permission granted
            if (permissionGranted) {
                if (rotationX !== undefined) {
                    // Adjust velocity based on rotation
                    velocityX = map(constrain(rotationY, -45, 45), -45, 45, -15, 15) * 80;
                    velocityY = map(constrain(rotationX, -45, 45), -45, 45, -15, 15) * 80;
                }
            }
            
            // Update circle position based on velocity
            cx += velocityX;
            cy += velocityY;
            
            // Keep the circle within the canvas
            cx = constrain(cx, 0, width);
            cy = constrain(cy, 0, height);
            
            // Calculate speed for color intensity
            let speed = dist(0, 0, velocityX, velocityY);
            
            // Create new particles if the circle has moved
            if (dist(cx, cy, lastCx, lastCy) > 3) {
                // Create more particles when moving faster
                let particleCount = map(speed, 0, 50, 1, 8);
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle(cx, cy, velocityX, velocityY, speed));
                }
                lastCx = cx;
                lastCy = cy;
            }
            
            // Update and display particles
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].display();
                if (particles[i].isDead()) {
                    particles.splice(i, 1);
                }
            }
            
            // Draw the main circle with color based on speed
            let brightness = constrain(map(speed, 0, 50, 150, 255), 150, 255);
            let redValue = constrain(map(speed, 0, 50, 200, 255), 200, 255);
            let yellowValue = constrain(map(speed, 0, 50, 100, 230), 100, 230);
            
            fill(redValue, yellowValue, 0);
            noStroke();
            ellipse(cx, cy, 30);
            
            // Add a glowing core at higher speeds
            if (speed > 10) {
                let glowSize = map(speed, 10, 50, 10, 25);
                fill(255, 255, 200, 200);
                ellipse(cx, cy, glowSize);
            }
        }
    </script>
</body>
</html>
